#!/bin/bash
export _sites_enabled="/etc/apache2/sites-enabled";
export _sites_available="/etc/apache2/sites-available";
export _mods_enabled="/etc/apache2/mods-enabled";
export _mods_available="/etc/apache2/mods-available";
export DEBUG_MODE="debug";

function isSudo(){
  if [[ "$EUID" -ne 0 ]]; then
    return 1;
  fi;
  return 0;
}

function logDebug() {
  if [[ "$DEBUG_MODE" == "debug" ]]; then
      echo "$(date) ${@}";
  fi;
}

function logMessage() {
    echo "$(date) ${@}";
}

function setupDocker() {
  logDebug "Running ${FUNCNAME[0]}";

  logDebug "Enabling Docker with proxy settings";
  sudo mkdir -p /etc/systemd/system/docker.service.d;
  sudo cat << EOF >> /etc/systemd/system/docker.service.d/proxy.conf
[Service]
Environment="HTTP_PROXY=${1}"
Environment="HTTPS_PROXY=${1}"
Environment="NO_PROXY=localhost,127.0.0.1,::1"
EOF
  sudo systemctl daemon-reload &>/dev/null;
  sudo systemctl restart docker &>/dev/null;

  logDebug "Initializing Docker instance";
  sudo docker-compose \
    --project-directory /opt/CVE-2022-24112-Lab/docker-files/ \
    -p docker-apisix up -d;

  logDebug "${FUNCNAME[0]} complete";
  return 0;
}

function setupApache() {
  logDebug "Running ${FUNCNAME[0]}";

  logMessage "Configuring Apache service";
  sudo systemctl stop apache2 &>/dev/null;

  logDebug "Backing up original Apache configuration files";
  for _file in "apache2.conf" "ports.conf"; do
    sudo cp "/etc/apache2/${_file}" "/etc/apache2/${_file}.orig";
  done;

  logDebug "Creating ports.conf configuration file for HTTP only";
  sudo cat << EOF > /etc/apache2/ports.conf
Listen 0.0.0.0:80
EOF

  logDebug "Creating apache2.conf configuration file";
  sudo cat << EOF > /etc/apache2/apache2.conf
# DEFAULT VALUES
DefaultRuntimeDir \${APACHE_RUN_DIR}
PidFile \${APACHE_PID_FILE}
Timeout 300
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5
HostnameLookups Off
# PROCESS CONTEXT
User \${APACHE_RUN_USER}
Group \${APACHE_RUN_GROUP}
# ERROR LOG LOCATION AND LEVEL
ErrorLog \${APACHE_LOG_DIR}/error.log
LogLevel warn
# MODULES INCLUDED
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf
# VIRTUAL HOST SETTINGS
Include ports.conf
<Directory />
	Options FollowSymLinks
	AllowOverride None
	Require all denied
</Directory>
<Directory /usr/share>
	AllowOverride None
	Require all granted
</Directory>
<Directory /var/www/>
	Options Indexes FollowSymLinks
	AllowOverride None
	Require all granted
</Directory>
AccessFileName .htaccess
<FilesMatch "^\.ht">
	Require all denied
</FilesMatch>
# LOG FORMAT SETTINGS
LogFormat "%v:%p %h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" vhost_combined
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %O" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent
# INCLUDE CONFIGURATION AND SITE FILES
IncludeOptional conf-enabled/*.conf
IncludeOptional sites-enabled/*.conf
EOF

  logDebug "Creating apache-www.conf configuration file and symlink";
  sudo cat << EOF > ${_sites_available}/apache-www.conf
<VirtualHost 0.0.0.0:80>
    ## MAIN SETTINGS:
    ServerAdmin admin@localhost
    ErrorLog /var/log/apache2/error.log
    CustomLog /var/log/apache2/access.log combined
    ServerName localhost
    DocumentRoot /var/www/html/
    RewriteEngine On
    SSLProxyEngine On
    SSLEngine off
    SSLProxyCheckPeerCN Off
    SSLProxyVerify none
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
    ## 1 DETECTION SETTINGS:
#   SecRuleEngine DetectionOnly
#   SecRule REQUEST_URI "@contains batch-requests" \
#      "id:'2022241121',phase:2,t:none,log,pass,status:403,msg:'CVE-2022-24112 - detected',chain"
#      SecRule REQUEST_BODY "pipeline" "chain"
#      SecRule &REQUEST_HEADERS_NAMES:X-API-KEY "@gt 0" "chain"
#      SecRule REQUEST_HEADERS_NAMES:X-Real-IP "@eq 127.0.0.1" "chain"
#      SecRule REQUEST_BODY "@contains pipeline" "chain"
#      SecRule REQUEST_BODY "@rx (.*os.execute.*)"
    ## 2 PREVENTION SETTINGS:
#   SecRuleEngine On
#   SecRule REQUEST_URI "@contains batch-requests" \
#      "id:'2022241122',phase:2,t:none,log,deny,status:403,msg:'CVE-2022-24112 - prevented',chain"
#      SecRule REQUEST_BODY "pipeline" "chain"
#      SecRule &REQUEST_HEADERS_NAMES:X-API-KEY "@gt 0" "chain"
#      SecRule REQUEST_HEADERS_NAMES:X-Real-IP "@eq 127.0.0.1" "chain"
#      SecRule REQUEST_BODY "@contains pipeline" "chain"
#      SecRule REQUEST_BODY "@rx (.*os.execute.*)"
    # MAIN SETTINGS:
    RewriteRule ^(.*) http://127.0.0.1:9080/$1 [NC,L,P]
</VirtualHost>
EOF
  for _conf in $(find ${_sites_enabled}/*conf); do
    sudo unlink ${_conf} &>/dev/null;
  done;
  sudo ln -s ${_sites_available}/apache-www.conf ${_sites_enabled}/apache-www.conf;

  logDebug "Enabling modsecurity recommended configuration file";
  sudo cp /etc/modsecurity/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf

  logDebug "Backing up configuration file";
  sudo cp ${_mods_enabled}/security2.conf ${_mods_available}/security2.conf.orig ;

  logDebug "Creating new ModSecurity mod-configuration file";
  sudo cat << EOF > ${_mods_available}/security2.conf
<IfModule security2_module>
  SecDataDir /var/cache/modsecurity
  IncludeOptional /etc/modsecurity/*.conf
</IfModule>
EOF

  logDebug "Enabling Apache modules";
  sudo a2enmod security2 &>/dev/null;
  sudo a2enmod proxy rewrite &>/dev/null;
  sudo a2enmod proxy proxy_http &>/dev/null;
  sudo a2enmod ssl &>/dev/null;

  logDebug "Enabling HTTP service";
  sudo systemctl start apache2 &>/dev/null;
  sudo systemctl enable apache2 &>/dev/null;
  logDebug "${FUNCNAME[0]} complete";
  return 0;
}

function runSetup() {
  logMessage "Running lab setup";

  if (! isSudo); then
    logMessage "Root privileges required";
    return 1;
  fi;

  logMessage "Setting up Docker instance";
  if (! setupDocker ${1}); then
    logMessage "Failed to setup Docker instance";
    return 1;
  fi;

  logMessage "Setting up Apache proxy";
  if (! setupApache); then
    logMessage "Failed to setup Apache proxy";
    return 1;
  fi;

  logMessage "Setup complete";
  return 0;
}

runSetup ${1}