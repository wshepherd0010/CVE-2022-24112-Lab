#!/usr/bin/env bash
# MAIN FILES
echo "$(date) Downloading dependencies";
sudo curl -isk https://github.com/wshepherd0010/CVE-2022-24112-Lab/raw/main/apache-files.zip -o /tmp/apache-files.zip
sudo curl -isk https://github.com/wshepherd0010/CVE-2022-24112-Lab/raw/main/docker-files.zip -o /tmp/docker-files.zip
# DOCKER
echo "$(date) Setting up Docker instance";
sudo unzip /tmp/docker-files.zip -d /opt/
sudo docker-compose --project-directory /opt/apisix-docker/ -p docker-apisix up -d;
# APACHE
echo "$(date) Setting up Apache instance";
sudo unzip /tmp/apache-files.zip -d /opt/
sudo cp /opt/apache/000-default.conf /etc/apache2/sites-available/000-default.conf
sudo cp /opt/apache/apache2.conf /etc/apache2/apache2.conf
sudo cp /opt/apache/ports.conf /etc/apache2/ports.conf
sudo cp /opt/apache/security2.conf /etc/apache2/mods-available/security2.conf
sudo cp /etc/modsecurity/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf
for _conf in $(find /etc/apache2/sites-enabled/*conf); do
  sudo unlink ${_conf} &>/dev/null;
done;
sudo ln -s /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-enabled/000-default.conf
echo "$(date) Enabling Apache modules";
sudo a2enmod security2 &>/dev/null;
sudo a2enmod proxy rewrite &>/dev/null;
sudo a2enmod proxy proxy_http &>/dev/null;
sudo a2enmod ssl &>/dev/null;
sudo systemctl start apache2 &>/dev/null;
sudo systemctl enable apache2 &>/dev/null;
echo "$(date) Finished setup";